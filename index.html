<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khanbogd Hub: Logistics & Mining</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Markdown Parser (marked) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
        }
        
        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .sidebar-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Markdown Styles */
        .prose h1 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .prose h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; margin-top: 1rem; }
        .prose p { margin-bottom: 0.5rem; font-size: 0.9rem; line-height: 1.5; }
        .prose ul { list-style-type: disc; padding-left: 1.25rem; margin-bottom: 0.5rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose strong { color: #1e3a8a; }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden relative font-sans">

    <!-- Mobile Header -->
    <div class="md:hidden absolute top-0 left-0 right-0 z-50 bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="text-lg font-bold text-gray-800">Khanbogd Hub</h1>
        <button id="menuBtn" class="text-gray-600 focus:outline-none">
            <i class="fas fa-bars fa-lg"></i>
        </button>
    </div>

    <div class="flex h-screen">
        
        <!-- Sidebar -->
        <div id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-50 w-96 bg-white shadow-lg flex flex-col h-full border-r border-gray-200">
            <!-- Sidebar Header -->
            <div class="p-6 bg-slate-900 text-white">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-2xl font-bold">South Gobi Hub</h2>
                    <button id="closeSidebar" class="md:hidden text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-slate-400 text-sm">Startup & Industry Ecosystem</p>
            </div>

            <!-- Locations List -->
            <div class="flex-1 overflow-y-auto sidebar-scroll p-4 space-y-4">
                
                <!-- Reference Point: Khanbogd -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r shadow-sm cursor-pointer hover:bg-blue-100 transition group" onclick="flyToLocation(43.1958, 107.2000)">
                    <div class="flex items-start">
                        <div class="mt-1 mr-3 text-blue-600 group-hover:scale-110 transition-transform">
                            <i class="fas fa-city fa-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">Khanbogd Soum Center</h3>
                            <p class="text-xs text-gray-500 mt-1">District Center (Startup HQ)</p>
                            <p class="text-xs text-gray-400 font-mono mt-1">43.1958° N, 107.2000° E</p>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-200 my-2"></div>
                
                <!-- Filters -->
                <div class="flex flex-wrap gap-2 mb-2">
                    <span class="px-2 py-1 bg-amber-100 text-amber-800 text-[10px] font-bold rounded uppercase">Mines</span>
                    <span class="px-2 py-1 bg-green-100 text-green-800 text-[10px] font-bold rounded uppercase">Services</span>
                    <span class="px-2 py-1 bg-cyan-100 text-cyan-800 text-[10px] font-bold rounded uppercase">Logistics</span>
                    <span class="px-2 py-1 bg-rose-100 text-rose-800 text-[10px] font-bold rounded uppercase">Power</span>
                </div>

                <!-- Mining List Container (Populated by JS) -->
                <div id="mining-list" class="space-y-3"></div>

            </div>

            <!-- AI Response Panel -->
            <div id="ai-panel" class="hidden absolute inset-0 bg-white z-50 flex flex-col shadow-2xl transform transition-transform duration-300 translate-y-full">
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 text-white flex justify-between items-center shadow-md">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-robot"></i>
                        <h3 class="font-bold">Gemini Intelligence</h3>
                    </div>
                    <button onclick="closeAiPanel()" class="hover:bg-white/20 rounded-full p-1 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 sidebar-scroll bg-gray-50">
                    <div id="ai-loading" class="hidden flex-col items-center justify-center h-full text-gray-500 space-y-3">
                        <div class="loader w-8 h-8 border-4 border-indigo-200 border-t-indigo-600"></div>
                        <p class="animate-pulse text-sm font-medium">Analyzing market opportunity...</p>
                    </div>
                    <div id="ai-content" class="prose prose-sm max-w-none text-gray-700">
                        <!-- Content goes here -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-200 bg-gray-50 text-center text-xs text-gray-500">
                <p>Data source: OpenStreetMap & Public Mining Records</p>
                <p class="mt-1">&copy; 2025 Khanbogd Maps</p>
            </div>
        </div>

        <!-- Overlay for mobile sidebar -->
        <div id="sidebarOverlay" class="hidden fixed inset-0 sidebar-overlay md:hidden"></div>

        <!-- Map Area -->
        <div class="flex-1 relative">
            <div id="map"></div>
            
            <!-- Map Legend (Floating) -->
            <div class="absolute bottom-6 right-6 bg-white/95 backdrop-blur-sm p-4 rounded-lg shadow-lg z-[400] text-sm hidden sm:block border border-gray-200 w-52">
                <h4 class="font-bold mb-3 text-gray-800 uppercase text-xs tracking-wider border-b pb-2">Legend</h4>
                <div class="flex items-center mb-2">
                    <span class="w-3 h-3 rounded-full bg-blue-500 mr-2 border border-white shadow-sm ring-1 ring-blue-200"></span>
                    <span>Soum Center</span>
                </div>
                <div class="flex items-center mb-2">
                    <span class="w-3 h-3 rounded-full bg-amber-500 mr-2 border border-white shadow-sm ring-1 ring-amber-200"></span>
                    <span>Major Mine</span>
                </div>
                <div class="flex items-center mb-2">
                    <span class="w-3 h-3 rounded-full bg-green-500 mr-2 border border-white shadow-sm ring-1 ring-green-200"></span>
                    <span>Service Cluster</span>
                </div>
                <div class="flex items-center mb-2">
                    <span class="w-3 h-3 rounded-full bg-cyan-500 mr-2 border border-white shadow-sm ring-1 ring-cyan-200"></span>
                    <span>Logistics Infrastructure</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-rose-500 mr-2 border border-white shadow-sm ring-1 ring-rose-200"></span>
                    <span>Power / Energy</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- Gemini API Configuration ---
        // ⚠️ INSTRUCTION: Paste your API Key inside the quotes below.
        // Note: Anyone who has this file can see this key.
        const apiKey = ""; 

        // --- Data Configuration ---
        const khanbogdCoords = { lat: 43.1958, lng: 107.2000 };
        
        // Comprehensive List for Tech Startup Context
        const miningSites = [
            // --- LOGISTICS & INFRASTRUCTURE (Critical for Tech) ---
            {
                id: 'airport',
                name: "Khanbumbat Airport (ZMKD)",
                desc: "Air Logistics Hub | OT",
                type: "infra",
                details: "Critical logistics node for FIFO workers. Coordinates personnel movement for Oyu Tolgoi.",
                coords: { lat: 43.1347, lng: 106.8472 }
            },
            {
                id: 'border',
                name: "Gashuun Sukhait Port",
                desc: "Border Crossing | Logistics",
                type: "infra",
                details: "The main coal export gateway to China. Major bottleneck; opportunities for queue management/logistics tech.",
                coords: { lat: 42.5450, lng: 107.5950 } // Approx border crossing
            },

             // --- ENERGY ---
             {
                id: 'windfarm',
                name: "Khanbogd Wind Farm (Project)",
                desc: "Renewable Energy | Planned",
                type: "energy",
                details: "102MW Wind Farm project located SE of Oyu Tolgoi. Represents green energy transition opportunities.",
                coords: { lat: 42.9500, lng: 107.2000 } // Approx SE of OT
            },

            // --- MAJOR MINES ---
            {
                id: 'ot',
                name: "Oyu Tolgoi (Rio Tinto)",
                desc: "Copper & Gold | Khanbogd",
                type: "major",
                details: "The anchor client. Highly automated, safety-focused. Uses procurement systems for IT/Tech services.",
                coords: { lat: 43.0083, lng: 106.8431 }
            },
            
            // --- SERVICE CLUSTER (Potential Clients) ---
            {
                id: 'khanbogd_khurd',
                name: "Khanbogd Khurd",
                desc: "Transport & Logistics",
                type: "service",
                details: "Major local transport company providing fleet services to OT. Potential client for fleet management tech.",
                coords: { lat: 43.1980, lng: 107.2030 } 
            },
            {
                id: 'sgms',
                name: "South Gobi Mining Services",
                desc: "Equipment & Parts",
                type: "service",
                details: "Supply chain heavyweight. Established in Khanbogd in 2014.",
                coords: { lat: 43.1920, lng: 107.2050 } 
            },
            {
                id: 'orem',
                name: "Orem Khanbogd",
                desc: "Engineering Solutions",
                type: "service",
                details: "Distributor for global industrial brands. Focus on engineering tech.",
                coords: { lat: 43.1900, lng: 107.1950 }
            },
            {
                id: 'wagner',
                name: "Wagner Asia Equipment",
                desc: "Caterpillar Dealer",
                type: "service",
                details: "Heavy equipment maintenance and sales.",
                coords: { lat: 43.1880, lng: 107.2100 }
            },

            // --- REGIONAL CONTEXT ---
            {
                id: 'tt_state',
                name: "Erdenes Tavan Tolgoi",
                desc: "State Coal Mine | Tsogttsetsii",
                type: "major",
                details: "Massive scale operations. High demand for efficiency and environmental monitoring tech.",
                coords: { lat: 43.6250, lng: 105.4742 }
            },
             {
                id: 'ts',
                name: "Tsagaan Suvarga (MAK)",
                desc: "Copper & Moly | Mandakh",
                type: "major",
                details: "Private sector giant (MAK). Developing smart mining capabilities.",
                coords: { lat: 43.8611, lng: 108.3361 }
            },
            {
                id: 'entree',
                name: "Entrée Resources (JV)",
                desc: "Exploration | Khanbogd",
                type: "exploration",
                details: "Hugo North Extension. Joint Venture partner.",
                coords: { lat: 43.0450, lng: 106.8600 }
            }
        ];

        // --- Map Initialization ---
        const map = L.map('map', { zoomControl: false }).setView([khanbogdCoords.lat, khanbogdCoords.lng], 9);
        
        L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // --- Custom Icons ---
        const IconBase = L.Icon.extend({
            options: {
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            }
        });

        const redIcon = new IconBase({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png' });
        const goldIcon = new IconBase({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png' });
        const greenIcon = new IconBase({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png' });
        const cyanIcon = new IconBase({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png' }); // Using grey for infra
        const roseIcon = new IconBase({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png' });
        const violetIcon = new IconBase({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png' });

        // --- Distance Logic ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        }

        function deg2rad(deg) { return deg * (Math.PI / 180); }

        // --- App Logic ---

        // 1. Draw Khanbogd Reference
        L.marker([khanbogdCoords.lat, khanbogdCoords.lng], { icon: redIcon })
            .addTo(map)
            .bindPopup(`
                <div class="font-sans min-w-[200px]">
                    <h3 class="font-bold text-blue-800 text-lg border-b pb-1 mb-2">Khanbogd Soum</h3>
                    <p class="text-sm text-gray-600">District Center</p>
                    <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded mt-2">Startup HQ</span>
                </div>
            `);

        // 2. Render List & Map Markers
        const listContainer = document.getElementById('mining-list');

        miningSites.forEach(site => {
            const distance = calculateDistance(khanbogdCoords.lat, khanbogdCoords.lng, site.coords.lat, site.coords.lng);
            
            // Determine Styling based on Type
            let markerIcon, iconColorClass, hoverBorder, iconClass;
            
            switch(site.type) {
                case 'major':
                    markerIcon = goldIcon;
                    iconColorClass = 'text-amber-500 group-hover:text-amber-600';
                    hoverBorder = 'hover:border-amber-300';
                    iconClass = 'fa-industry';
                    break;
                case 'service':
                    markerIcon = greenIcon;
                    iconColorClass = 'text-green-600 group-hover:text-green-700';
                    hoverBorder = 'hover:border-green-300';
                    iconClass = 'fa-tools';
                    break;
                case 'infra':
                    markerIcon = cyanIcon;
                    iconColorClass = 'text-cyan-600 group-hover:text-cyan-700';
                    hoverBorder = 'hover:border-cyan-300';
                    iconClass = site.id === 'airport' ? 'fa-plane' : 'fa-truck-moving';
                    break;
                case 'energy':
                    markerIcon = roseIcon;
                    iconColorClass = 'text-rose-600 group-hover:text-rose-700';
                    hoverBorder = 'hover:border-rose-300';
                    iconClass = 'fa-wind';
                    break;
                default:
                    markerIcon = violetIcon;
                    iconColorClass = 'text-indigo-500 group-hover:text-indigo-600';
                    hoverBorder = 'hover:border-indigo-300';
                    iconClass = 'fa-search-location';
            }

            // A. Create Sidebar Card
            const card = document.createElement('div');
            card.className = `bg-white border border-gray-200 p-3 rounded-lg shadow-sm cursor-pointer hover:shadow-md ${hoverBorder} transition group relative overflow-hidden`;
            card.innerHTML = `
                <div class="flex items-start justify-between relative z-10">
                    <div class="flex items-start w-full" onclick="flyToLocation(${site.coords.lat}, ${site.coords.lng})">
                        <div class="mt-1 mr-3 ${iconColorClass} transition-colors">
                            <i class="fas ${iconClass} fa-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800 text-sm transition-colors">${site.name}</h3>
                            <p class="text-xs text-gray-500 mt-0.5">${site.desc}</p>
                        </div>
                    </div>
                </div>
                <div class="mt-2 flex items-center justify-between relative z-10">
                    <div class="flex items-center bg-gray-50 rounded px-2 py-1 text-[10px] text-gray-600">
                        <i class="fas fa-location-arrow mr-1 opacity-50"></i>
                        <span class="font-semibold">${distance} km</span>
                    </div>
                    <button onclick="askGemini('${site.name}')" class="flex items-center gap-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-[10px] font-semibold transition-colors border border-indigo-200">
                        <i class="fas fa-sparkles"></i>
                        Analysis
                    </button>
                </div>
            `;
            listContainer.appendChild(card);

            // B. Create Map Marker
            const popupContent = `
                <div class="font-sans min-w-[220px]">
                    <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-2">
                        <i class="fas ${iconClass} ${iconColorClass}"></i>
                        <h3 class="font-bold text-gray-800 text-base m-0">${site.name}</h3>
                    </div>
                    <p class="text-sm text-gray-600 mb-2 leading-snug">${site.details}</p>
                    <div class="flex items-center justify-between mt-3">
                        <span class="text-xs font-mono font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded">${distance} km</span>
                        <button onclick="askGemini('${site.name}')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1.5 rounded shadow-sm transition-colors">
                            <i class="fas fa-robot mr-1"></i> AI Analysis
                        </button>
                    </div>
                </div>
            `;

            L.marker([site.coords.lat, site.coords.lng], { icon: markerIcon })
                .addTo(map)
                .bindPopup(popupContent);

            // C. Draw Connector Line (Only for mines > 1km away)
            if (distance > 2) {
                L.polyline([
                    [khanbogdCoords.lat, khanbogdCoords.lng],
                    [site.coords.lat, site.coords.lng]
                ], {
                    color: '#64748b',
                    weight: 1,
                    opacity: 0.1,
                    dashArray: '4, 8'
                }).addTo(map);
            }
        });

        // --- Interaction Functions ---

        function flyToLocation(lat, lng) {
            map.flyTo([lat, lng], 10, { animate: true, duration: 1.5 });
            if (window.innerWidth < 768) toggleSidebar();
        }

        // --- Sidebar Logic ---
        const menuBtn = document.getElementById('menuBtn');
        const closeSidebar = document.getElementById('closeSidebar');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        let isSidebarOpen = false;

        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            if (isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        menuBtn.addEventListener('click', toggleSidebar);
        closeSidebar.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        // --- Gemini Integration ---

        const aiPanel = document.getElementById('ai-panel');
        const aiContent = document.getElementById('ai-content');
        const aiLoading = document.getElementById('ai-loading');

        function openAiPanel() {
            aiPanel.classList.remove('translate-y-full');
            aiPanel.classList.remove('hidden');
            if (!isSidebarOpen && window.innerWidth < 768) {
                toggleSidebar();
            }
        }

        function closeAiPanel() {
            aiPanel.classList.add('translate-y-full');
            setTimeout(() => aiPanel.classList.add('hidden'), 300);
        }

        async function askGemini(targetName) {
            openAiPanel();
            aiContent.innerHTML = '';
            aiLoading.classList.remove('hidden');
            aiLoading.classList.add('flex');

            const systemPrompt = `You are a startup business consultant specializing in the Mongolian mining sector. 
            Analyze the market opportunity for "${targetName}".
            1. **The Need:** What does this entity likely need from a tech startup? (e.g., logistics software, safety apps, environmental monitoring).
            2. **The Pain Points:** What are their known challenges? (e.g., remote location, dust, turnover).
            3. **The Pitch:** How should a startup approach them?
            Use Markdown formatting. Be specific.`;
            
            const userQuery = `Analyze tech opportunities for ${targetName}.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                if (!response.ok) throw new Error('API Request Failed');
                
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No information available.";
                
                aiContent.innerHTML = marked.parse(text);

            } catch (error) {
                console.error(error);
                aiContent.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    Sorry, I couldn't fetch the AI analysis at this moment. Please try again later.
                </div>`;
            } finally {
                aiLoading.classList.add('hidden');
                aiLoading.classList.remove('flex');
            }
        }

    </script>
</body>
</html>
